# 计算机体系结构概述

## BIOS启动固件

CS:IP = 0xf000:fff0.
(CS: 代码段寄存器；IP: 指令指针寄存器)
系统处于实模式
PC = 16 * CS + IP
20位地址空间： 1MB

- 基本的输入输出的程序
- 系统设置信息
- 开机后自检程序
- 系统自启动程序等

## BIOS

- 将加载程序从磁盘的引导扇区(512字节) 加载到 0x7c00.
- 跳转到 CS:IP = 0000:7c00

## 加载程序
- 将操作系统的代码和数据从硬盘加载到内存中
- 跳转到操作系统的起始地址

 ## BIOS系统调用
`BIOS以中断调用的方式 提供了基本的I/O功能`
- INT 10h: 字符显示
- INT 13h: 磁盘扇区读写
- INT 15h: 检测内存大小
- INT 16h: 键盘输入
- 在Intel的CPU上只能在x86的实模式喜爱访问

## 系统启动流程


![](./_image/2017-04-25-20-35-17.jpg)

### CPU初始化
`CPU加点稳定后从 0XFFFF0读第一条指令`
- CS:IP = 0xf000:fff0
- 第一条指令是跳转指令

`CPU初始状态为16位实模式`
- CS:IP是16位寄存器
- 指令指针PC = 16 * CS + IP
- 最大地址空间是1MB

### BIOS 初始化过程
`硬件自检POST`
`检查系统内存和显卡等关键部件的存在和工作状态`
`查找并执行显卡等接口卡BIOS，进行设备初始化`
`执行系统BIOS，进行系统检测`
- 检测和配置系统中安装的即插即用设备

`更新CMOS中的扩展系统配置数据ESCD`
`按指定启动顺序从软盘、硬盘或光驱启动`

### 主引导记录MBR格式
`启动代码：446字节`
- 检查分区表正确性
- 加载并跳转到硬盘上的引导程序

`硬盘分区表: 64字节`
- 描述分区状态和位置
- 每个分区描述信息占据16字节

`结束标志字：2字节(55AA)`
- 主引导记录的有效状态

### 分区引导扇区格式

![](./_image/2017-04-25-20-45-59.jpg)ootloader

## 加载程序（bootloader）

![](./_image/2017-04-25-20-47-31.jpg)

## 系统启动规范
`BIOS`
- 固化到计算机主板上的程序
- 包括系统设置、自检程序和系统自启动程序
- BIOS-MBR、BIOS-GPT、PXE

`UEFI`
- 接口标准
- 在所有平台上一致的操作系统启动服务

## 中断、异常和系统调用

`? 为什么需要中断、异常和系统调用`
- 在计算机运行中，内核是被信任的第三方
- 职员内核可以执行特权指令
- 方便应用程序

`中断和异常希望解决的问题`
- 当外设连接计算机时，会出现什么现象?
- 当应用程序处理意想不到的行为时，会出现什么现象？

`系统调用希望解决的问题`
- 用户应用程序是如何得到系统服务的？
- 系统调用和功能 调用的不同之处是什么？

### 内核的进入与退出

![](./_image/2017-04-25-20-59-54.jpg)


### 中断、异常和系统调用
- 系统调用(system call): 应用程序主动向操作系统发出的服务请求
- 异常(exception): 非法指令或其他原因导致当前 指令执行失败(如：内存出错)后的处理请求
- 中断(hardware interrupt)：来自硬件设备的处理请求


![](./_image/2017-04-25-21-04-28.jpg)

### 中断嵌套

![](./_image/2017-04-25-21-07-53.jpg)

## 系统调用

![](./_image/2017-04-25-21-14-00.jpg)

![](./_image/2017-04-25-21-15-10.jpg)

###   函数调用和系统调用的不同处

![](./_image/2017-04-25-21-17-14.jpg)

### 中断、异常和系统调用的开销


![](./_image/2017-04-25-21-18-18.jpg)


